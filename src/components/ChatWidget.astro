---
// ChatWidget - Vanilla JS AI chat powered by Gemini
---

<div id="chat-widget" class="fixed bottom-6 right-6 z-40 flex flex-col items-end">
  <!-- Chat Window -->
  <div id="chat-window" class="hidden bg-white rounded-2xl shadow-2xl border border-gray-100 w-80 sm:w-96 mb-4 overflow-hidden flex flex-col animate-fade-in-up" style="max-height: 600px; height: 500px;">
    <!-- Header -->
    <div class="bg-slate-900 text-white p-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <div class="bg-wood-500 p-1.5 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
            <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>
            <path d="M5 3v4"/>
            <path d="M19 17v4"/>
            <path d="M3 5h4"/>
            <path d="M17 19h4"/>
          </svg>
        </div>
        <div>
          <h3 class="font-semibold text-sm">Summit Assistant</h3>
          <p class="text-xs text-slate-300">Powered by Gemini AI</p>
        </div>
      </div>
      <button id="chat-close-btn" class="text-slate-400 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 6 6 18"/>
          <path d="m6 6 12 12"/>
        </svg>
      </button>
    </div>

    <!-- Messages -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 bg-gray-50 space-y-4">
      <div class="flex justify-start">
        <div class="max-w-[85%] rounded-2xl px-4 py-3 text-sm bg-white text-slate-800 shadow-sm border border-gray-100 rounded-tl-none">
          Hi! I'm Summit AI. How can I help you with your decking project today?
        </div>
      </div>
    </div>

    <!-- Input -->
    <form id="chat-form" class="p-3 bg-white border-t border-gray-100">
      <div class="relative">
        <input
          type="text"
          id="chat-input"
          placeholder="Ask about decks, materials, quotes..."
          class="w-full pl-4 pr-12 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-wood-500/20 focus:border-wood-500 text-sm transition-all"
        />
        <button
          type="submit"
          id="chat-submit"
          class="absolute right-2 top-1/2 transform -translate-y-1/2 p-1.5 bg-wood-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-wood-700 transition-colors"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"/>
            <path d="m21.854 2.147-10.94 10.939"/>
          </svg>
        </button>
      </div>
    </form>
  </div>

  <!-- Toggle Button -->
  <button
    id="chat-toggle"
    class="h-14 w-14 rounded-full bg-wood-600 text-white shadow-lg shadow-wood-600/30 flex items-center justify-center hover:bg-wood-700 hover:scale-105 transition-all duration-300"
  >
    <svg id="chat-icon-message" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/>
    </svg>
    <svg id="chat-icon-close" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M18 6 6 18"/>
      <path d="m6 6 12 12"/>
    </svg>
  </button>
</div>

<script>
  const chatWidget = document.getElementById('chat-widget');
  const chatWindow = document.getElementById('chat-window');
  const chatToggle = document.getElementById('chat-toggle');
  const chatCloseBtn = document.getElementById('chat-close-btn');
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input') as HTMLInputElement;
  const chatMessages = document.getElementById('chat-messages');
  const chatSubmit = document.getElementById('chat-submit');
  const chatIconMessage = document.getElementById('chat-icon-message');
  const chatIconClose = document.getElementById('chat-icon-close');

  let isOpen = false;
  let isLoading = false;

  function toggleChat() {
    isOpen = !isOpen;
    chatWindow?.classList.toggle('hidden', !isOpen);
    chatIconMessage?.classList.toggle('hidden', isOpen);
    chatIconClose?.classList.toggle('hidden', !isOpen);

    if (isOpen) {
      scrollToBottom();
      chatInput?.focus();
    }
  }

  function scrollToBottom() {
    if (chatMessages) {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  }

  function addMessage(text: string, role: 'user' | 'model', isError = false) {
    if (!chatMessages) return;

    const msgDiv = document.createElement('div');
    msgDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

    const bubble = document.createElement('div');
    bubble.className = `max-w-[85%] rounded-2xl px-4 py-3 text-sm ${
      role === 'user'
        ? 'bg-wood-600 text-white rounded-tr-none'
        : isError
          ? 'bg-red-50 text-red-600 border border-red-100 rounded-tl-none'
          : 'bg-white text-slate-800 shadow-sm border border-gray-100 rounded-tl-none'
    }`;
    bubble.textContent = text;

    msgDiv.appendChild(bubble);
    chatMessages.appendChild(msgDiv);
    scrollToBottom();
  }

  function showLoading() {
    if (!chatMessages) return;

    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'chat-loading';
    loadingDiv.className = 'flex justify-start';
    loadingDiv.innerHTML = `
      <div class="bg-white text-slate-800 shadow-sm border border-gray-100 rounded-2xl rounded-tl-none px-4 py-3 flex items-center space-x-2">
        <svg class="animate-spin h-4 w-4 text-wood-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-xs text-slate-400">Thinking...</span>
      </div>
    `;
    chatMessages.appendChild(loadingDiv);
    scrollToBottom();
  }

  function hideLoading() {
    const loadingDiv = document.getElementById('chat-loading');
    loadingDiv?.remove();
  }

  async function sendMessage(userMessage: string) {
    if (!userMessage.trim() || isLoading) return;

    addMessage(userMessage, 'user');
    isLoading = true;
    if (chatSubmit) chatSubmit.setAttribute('disabled', 'true');
    showLoading();

    // Simulated AI response (replace with actual API call if you have a backend)
    // For a real implementation, you'd need a server-side API route
    try {
      // Simulate API delay
      await new Promise(resolve => setTimeout(resolve, 1000));

      // Predefined responses based on keywords
      const lowerMsg = userMessage.toLowerCase();
      let response = '';

      if (lowerMsg.includes('price') || lowerMsg.includes('cost') || lowerMsg.includes('quote')) {
        response = "I can give you a rough estimate range, but for an exact quote, please fill out our contact form or call us at (555) 123-4567. Deck costs typically range from $25-$75 per square foot depending on materials.";
      } else if (lowerMsg.includes('composite') || lowerMsg.includes('trex')) {
        response = "Composite decking like Trex or TimberTech is a fantastic low-maintenance option. It resists fading, staining, and scratching, and comes with 25-50 year warranties. Perfect if you want to spend time enjoying your deck instead of maintaining it!";
      } else if (lowerMsg.includes('wood') || lowerMsg.includes('cedar') || lowerMsg.includes('ipe')) {
        response = "Natural wood offers unmatched warmth and character. We work with Western Red Cedar for classic beauty, and exotic hardwoods like Ipe and Cumaru for extreme durability. Wood does require annual maintenance, but many homeowners love the natural aging process.";
      } else if (lowerMsg.includes('warranty')) {
        response = "We offer a comprehensive 5-year workmanship warranty on all our projects. Additionally, the materials we use often come with their own manufacturer warranties ranging from 25-50 years.";
      } else if (lowerMsg.includes('time') || lowerMsg.includes('long') || lowerMsg.includes('duration')) {
        response = "Most standard deck projects take 1-2 weeks once construction begins. Larger, more complex projects with covers or hardscapes may take 3-4 weeks. We handle all permitting which typically takes 2-3 weeks before construction.";
      } else {
        response = "Great question! For the most accurate information about your specific project, I'd recommend reaching out to our team directly. You can fill out our contact form or call us at (555) 123-4567. We're happy to provide a free site evaluation!";
      }

      hideLoading();
      addMessage(response, 'model');
    } catch (error) {
      hideLoading();
      addMessage("I'm having trouble connecting right now. Please try again later or call our office at (555) 123-4567.", 'model', true);
    } finally {
      isLoading = false;
      if (chatSubmit) chatSubmit.removeAttribute('disabled');
    }
  }

  chatToggle?.addEventListener('click', toggleChat);
  chatCloseBtn?.addEventListener('click', toggleChat);

  chatForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    const message = chatInput?.value.trim();
    if (message) {
      sendMessage(message);
      if (chatInput) chatInput.value = '';
    }
  });
</script>
